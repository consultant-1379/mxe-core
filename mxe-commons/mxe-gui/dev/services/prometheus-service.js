const API_BASE_URL = '/v1';

const CHART_DATA = {
  status: 'success',
  data: {
    resultType: 'matrix',
    result: [
      {
        metric: { mxe_metric_name: 'testName' },
        values: [
          [1574422683, '0'],
          [1574422688, '0.09334722222222223'],
          [1574422693, '0.08879545454545455'],
          [1574422698, '0.10450625'],
          [1574422703, '0.10343333333333332'],
          [1574422708, '0.10276919822610373'],
          [1574422713, '0.1023258064516129'],
          [1574422718, '0.10200277777777776'],
          [1574422723, '0.10175853658536585'],
          [1574422728, '0.10156739130434782'],
          [1574422733, '0.10141372549019607'],
          [1574422738, '0.10128570727053342'],
          [1574422743, '0.08474719910506959'],
          [1574422748, '0.01694915254237288'],
          [1574422753, '0.01694915254237288'],
          [1574422758, '0'],
          [1574422763, '0'],
          [1574422768, '0'],
          [1574422773, '0'],
          [1574422778, '0'],
          [1574422783, '0'],
          [1574422788, '0'],
          [1574422793, '0'],
          [1574422798, '0'],
          [1574422803, '0'],
          [1574422808, '0'],
          [1574422813, '0'],
          [1574422818, '0'],
          [1574422823, '0'],
          [1574422828, '0'],
          [1574422833, '0'],
          [1574422838, '0'],
          [1574422843, '0'],
          [1574422848, '0'],
          [1574422853, '0'],
          [1574422858, '0'],
          [1574422863, '0'],
          [1574422868, '0'],
          [1574422873, '0'],
          [1574422878, '0'],
          [1574422883, '0'],
          [1574422888, '0'],
          [1574422893, '0'],
          [1574422898, '0'],
          [1574422903, '0'],
          [1574422908, '0'],
          [1574422913, '0'],
          [1574422918, '0'],
          [1574422923, '0'],
          [1574422928, '0'],
          [1574422933, '0'],
          [1574422938, '0'],
          [1574422943, '0'],
          [1574422948, '0'],
          [1574422953, '0'],
          [1574422958, '0'],
          [1574422963, '0'],
          [1574422968, '0'],
          [1574422973, '0'],
          [1574422978, '0'],
          [1574422983, '0'],
          [1574422988, '0'],
          [1574422993, '0'],
          [1574422998, '0'],
          [1574423003, '0'],
          [1574423008, '0'],
          [1574423013, '0'],
          [1574423018, '0'],
          [1574423023, '0'],
          [1574423028, '0'],
          [1574423033, '0'],
          [1574423038, '0'],
          [1574423043, '0'],
          [1574423048, '0'],
          [1574423053, '0'],
          [1574423058, '0'],
          [1574423063, '0'],
          [1574423068, '0'],
          [1574423073, '0'],
          [1574423078, '0'],
          [1574423083, '0'],
          [1574423088, '0'],
          [1574423093, '0'],
          [1574423098, '0'],
          [1574423103, '0'],
          [1574423108, '0'],
          [1574423113, '0'],
          [1574423118, '0'],
          [1574423123, '0'],
          [1574423128, '0'],
          [1574423133, '0'],
          [1574423138, '0'],
          [1574423143, '0'],
          [1574423148, '0'],
          [1574423153, '0'],
          [1574423158, '0'],
          [1574423163, '0'],
          [1574423168, '0'],
          [1574423173, '0'],
          [1574423178, '0'],
          [1574423183, '0'],
        ],
      },
    ],
  },
};
const CHART_DATA_V2 = {
  status: 'success',
  data: {
    resultType: 'matrix',
    result: [
      {
        metric: { mxe_metric_name: 'testName' },
        values: [
          [1574422683, '0'],
          [1574422688, '0.09334722222222223'],
          [1574422693, '0.08879545454545455'],
          [1574422698, '0.10450625'],
          [1574422703, '0.10343333333333332'],
          [1574422708, '0.10276919822610373'],
          [1574422713, '0.1023258064516129'],
          [1574422718, '0.10200277777777776'],
          [1574422723, '0.10175853658536585'],
          [1574422728, '0.10156739130434782'],
          [1574422733, '0.10141372549019607'],
          [1574422738, '0.10128570727053342'],
          [1574422743, '0.08474719910506959'],
          [1574422748, '0.01694915254237288'],
        ],
      },
    ],
  },
};

const METRICS = {
  status: 'success',
  data: {
    resultType: 'vector',
    result: [
      {
        metric: { __name__: 'seldon_api_test_custom_timer_seconds' },
        value: [1570539333.227, '0'],
      },
      {
        metric: { __name__: 'seldon_api_test_custom_timer_seconds_count' },
        value: [1570539333.227, '12'],
      },
      {
        metric: { __name__: 'seldon_api_executor_client_requests_seconds' },
        value: [1570539333.227, '0'],
      },
      {
        metric: { __name__: 'seldon_api_test_custom_counter_total' },
        value: [1570539333.227, '79.79899859428406'],
      },
      {
        metric: { __name__: 'seldon_api_test_custom_timer_seconds_bucket' },
        value: [1570539333.227, '828'],
      },
      {
        metric: { __name__: 'seldon_api_executor_client_requests_seconds_count' },
        value: [1570539333.227, '12'],
      },
      {
        metric: { __name__: 'seldon_api_executor_client_requests_seconds_max' },
        value: [1570539333.227, '0'],
      },
      {
        metric: { __name__: 'seldon_api_test_custom_timer_seconds_sum' },
        value: [1570539333.227, '0.012'],
      },
      {
        metric: { __name__: 'seldon_api_executor_client_requests_seconds_bucket' },
        value: [1570539333.227, '674'],
      },
      {
        metric: { __name__: 'seldon_api_executor_client_requests_seconds_sum' },
        value: [1570539333.227, '0.140602012'],
      },
      {
        metric: { __name__: 'seldon_api_test_custom_gauge' },
        value: [1570539333.227, '5.234000205993652'],
      },
      {
        metric: { __name__: 'seldon_api_test_custom_timer_seconds_max' },
        value: [1570539333.227, '0'],
      },
    ],
  },
};
let switcher = true;

/**
 * Prometheus service
 * @param app
 */
module.exports = (app) => {
  app.get(`${API_BASE_URL}/prometheus/api/v1`, (req, res) => {
    res.send(CHART_DATA);
  });

  app.post(`${API_BASE_URL}/prometheus/api/v1/query`, (req, res) => {
    const { query } = req.body;

    if (query && (query.includes('seconds') || query.includes('total'))) {
      res.send(CHART_DATA);
      return;
    }

    res.send(METRICS);
  });

  app.post(`${API_BASE_URL}/prometheus/api/v1/query_range`, (req, res) => {
    switcher = Math.random() >= 0.5;

    if (switcher) {
      for (let i = CHART_DATA_V2.data.result[0].values.length; i > 0; i--) {
        const data = CHART_DATA_V2.data.result[0].values[i - 1];
        data[0] = Math.floor(Date.now() / 1000 - i * 5);
      }
      return res.send(CHART_DATA_V2);
    }

    for (let i = CHART_DATA.data.result[0].values.length; i > 0; i--) {
      const data = CHART_DATA.data.result[0].values[i - 1];
      data[0] = Math.floor(Date.now() / 1000 - i * 5);
    }
    return res.send(CHART_DATA);
  });
};
